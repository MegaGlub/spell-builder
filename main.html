<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class = "mainMenuScreen" id = "mainMenuScreen">
    <span class = "mainMenuButtons">
      <button class = "mainMenuSpellsButton" onclick = "mainMenuSpellsButtonPress()" id = "mainMenuSpellsButton">
        Spell Workbench</button>
      <button class = "mainMenuMartialsButton" onclick = "mainMenuMartialsButtonPress()" id = "mainMenuMartialsButton">
        Martial Arts</button>
    </span>
  </div>

  <span class = "spellBox">
  </span>

  <span class = "wandBox">
    <span class = "wandSelector">
    </span>
  </span>
  
  <div class = "bottomToolBar">
    <button class = "bottomToolBarButton" onclick = "unhideMainMenu()">
      Main Menu
    </button>
  </div>
</body>
<script>
  var fs = module.require('fs');
  const mainMenuSpellsButton = document.getElementById("mainMenuSpellsButton");
  const mainMenuMartialsButton = document.getElementById("mainMenuMartialsButton");
  const mainMenuScreen = document.getElementById("mainMenuScreen");
  const toolTipButtons = document.getElementsByClassName("toolTipButton");
  const spellBox = document.getElementsByClassName("spellBox")[0];

  const root = "data/components";
  var miscList = readJSONDirectory(root + "/misc");
  var pathList = readJSONDirectory(root + "/paths");
  var formList = readJSONDirectory(root + "/forms");
  var purposeList = readJSONDirectory(root + "/purposes");
  var enhancementList = readJSONDirectory(root + "/enhancements");
  var triggerList = readJSONDirectory(root + "/triggers");

  class spellComponent {
    constructor(name, type, description, image, primaryCost, primaryType, secondaryCost, secondaryType, energyCost, potencyModifier){
      this.name = name;
      this.type = type;
      this.description = description;
      this.image = image;
      this.primaryCost = primaryCost;
      this.primaryType = primaryType;
      this.secondaryCost = secondaryCost;
      this.secondaryType = secondaryType;
      this.energyCost = energyCost;
      this.potencyModifier = potencyModifier;

      this.buildComponentVisuals();
      assignToolTip(this.toolTipButtonElement);
      componentList.push(this);
    }

    buildComponentVisuals(){
      this.#createEmptyElements();
      this.#assignElementClasses();
      this.#assignElementIds();
      this.#assignImage();
      this.#relateElements();
      this.fillInnerHTML();
      this.#colorizeText();
    }
    #createEmptyElements(){
      this.toolTipButtonElement = document.createElement("div");
      this.toolTipElement = document.createElement("div");
      this.spellTitleElement = document.createElement("div");
      this.spellTypeElement = document.createElement("div");
      this.spellDescriptionElement = document.createElement("div");
      this.componentElement = document.createElement("span");
      this.imageElement = document.createElement("img");
      this.statTableElement = document.createElement("table");
      this.visRowElement = document.createElement("tr");
      this.primaryCellElement = document.createElement("td");
      this.secondaryCellElement = document.createElement("td");
      this.energyCellElement = document.createElement("td");
      this.modifierRowElement = document.createElement("tr");
      this.potencyCellElement = document.createElement("td");
    }
    #assignElementClasses(){
      this.toolTipButtonElement.className = "toolTipButton";
      this.toolTipElement.className = "toolTip";
      this.spellTitleElement.className = "spellTitle";
      this.spellTypeElement.className = "spellType";
      this.spellDescriptionElement.className = "spellDescription";
      this.componentElement.className = "spellComponent";
      this.statTableElement.className = "componentStatTable";
      this.visRowElement.className = "componentStatRow";
      this.primaryCellElement.className = "componentStatCell";
      this.secondaryCellElement.className = "componentStatCell";
      this.energyCellElement.className = "componentStatCell";
      this.modifierRowElement.className = "componentStatRow";
      this.potencyCellElement.className = "componentStatCell";
    }
    #assignElementIds(){
      this.toolTipButtonElement.id = "spellComponent" + this.name;
    }
    #relateElements(){
      spellBox.appendChild(this.toolTipButtonElement);
      this.toolTipButtonElement.appendChild(this.componentElement);
      this.toolTipButtonElement.appendChild(this.toolTipElement);
      this.toolTipElement.appendChild(this.spellTitleElement);
      this.toolTipElement.appendChild(this.spellTypeElement);
      this.toolTipElement.appendChild(this.spellDescriptionElement);
      this.toolTipElement.appendChild(this.statTableElement);
      this.statTableElement.appendChild(this.visRowElement);
      this.visRowElement.appendChild(this.primaryCellElement);
      this.visRowElement.appendChild(this.secondaryCellElement);
      this.visRowElement.appendChild(this.energyCellElement);
      this.statTableElement.appendChild(this.modifierRowElement);
      this.modifierRowElement.appendChild(this.potencyCellElement);
      this.componentElement.appendChild(this.imageElement);
    }
    #assignImage() {
      this.imageElement.src = this.image;
    }
    fillInnerHTML() {
      this.spellTitleElement.innerHTML = this.name;
      this.spellTypeElement.innerHTML = this.type;
      this.spellDescriptionElement.innerHTML = this.description;

      this.#fillStatTable();
    }
    #fillStatTable(){
      this.primaryCellElement.innerHTML = this.formattedDataCell(this.primaryCost, this.primaryType);
      this.secondaryCellElement.innerHTML = this.formattedDataCell(this.secondaryCost, this.secondaryType);
      this.energyCellElement.innerHTML = this.formattedDataCell(this.energyCost, "Energy");

      this.potencyCellElement.innerHTML = this.formattedDataCell(this.potencyModifier, "Potency");
    }
    #colorizeText(){
      this.spellTypeElement.style.color = this.getTypeColor();
    }

    formattedDataCell(num, descriptor){
      if (this.type == "Void"){
        if (descriptor == "Energy"){
          return "Nullified " + descriptor;
        }else {
        return "Inverted " + descriptor;
        }
      }else{
        return this.getSign(num) + " " + descriptor;
      }
    }

    getSign(num){
      if (num < 0){
        return num; // negative numbers already have the "-" character
      } else{
        return "+" + num;
      }
    }

    getTypeColor(){
      switch(this.type){
        case "Void":
          return "#8A2BE2";
        case "Form":
          return "#3CB371";
        case "Path":
          return "#DAA520";
        case "Purpose":
          return "#A0AECD";
        case "Enhancement":
          return "#6495ED";
        case "Refund":
          return "#BC8F8F";
        case "Trigger":
          return "#FA8072";
        default:
          return "#FFFFF0";
      }
    }
  }
  class formComponent extends spellComponent{
    constructor(name, description, formDescription, image, primaryCost, secondaryCost, energyCost, potencyModifier, size){
      super(name, "Form", description, image, primaryCost, "Primary", secondaryCost, "Secondary", energyCost, potencyModifier);
      this.formDescription = formDescription;
      this.size = size;
      this.buildFormVisuals();
    }

    buildFormVisuals(){
      this.#createEmptyElements();
      this.#assignElementClasses();
      this.#relateElements();
      this.#fillInnerHTML();
    }
    #createEmptyElements(){
      this.sizeCellElement = document.createElement("td");
    }
    #assignElementClasses(){
      this.sizeCellElement.className = "componentStatCell";
    }
    #relateElements(){
      this.modifierRowElement.appendChild(this.sizeCellElement);
    }
    #fillInnerHTML(){
      this.sizeCellElement.innerHTML = "Size: " + this.size;
    }
  }

  class pathComponent extends spellComponent{
    constructor(name, description, pathDescription, image, primaryCost, secondaryCost, energyCost, potencyModifier, range, lifetime){
      super(name, "Path", description, image, primaryCost, "Primary", secondaryCost, "Secondary", energyCost, potencyModifier);
      this.pathDescription = pathDescription;
      this.range = range;
      this.lifetime = lifetime;
      this.buildPathVisuals();
    }

    buildPathVisuals(){
      this.#createEmptyElements();
      this.#assignElementClasses();
      this.#relateElements();
      this.#fillInnerHTML();
    }
    #createEmptyElements(){
      this.rangeCellElement = document.createElement("td");
      this.lifetimeCellElement = document.createElement("td");
    }
    #assignElementClasses(){
      this.rangeCellElement.className = "componentStatCell";
      this.lifetimeCellElement.className = "componentStatCell";
    }
    #relateElements(){
      this.modifierRowElement.appendChild(this.rangeCellElement);
      this.modifierRowElement.appendChild(this.lifetimeCellElement);
    }
    #fillInnerHTML(){
      this.rangeCellElement.innerHTML = "Range: ~" + this.range;
      this.lifetimeCellElement.innerHTML = "Proj. Life: " + this.timeFormat(this.lifetime);
    }

    timeFormat(seconds){
      if (seconds == 3600){
        return "1 hour";
      }
      else if (seconds / 3600 > 1){
        return this.roundTo2(seconds / 3600) + " hours";
      }
      else if (seconds == 60){
        return "1 minute";
      }
      else if (seconds / 60 > 1){
        return this.roundTo2(seconds / 60) + " minutes";
      }
      else if (seconds == 1){
        return "1 second";
      }else{
        return seconds + " seconds";
      }
    }

    roundTo2(num){
      return Math.round(num * 100) / 100;
    }
  }

  class triggerComponent extends spellComponent{
    constructor(name, description, triggerDescription, image, primaryCost, secondaryCost, energyCost, potencyModifier){
      super(name, "Trigger", description, image, primaryCost, "Primary", secondaryCost, "Secondary", energyCost, potencyModifier);
      this.triggerDescription = triggerDescription;
    }
  }

  class enhancementComponent extends spellComponent{
    constructor(name, description, enhancementDescription, image, primaryCost, secondaryCost, energyCost, enhancementType, enhancementModifier, enhancementMultiplier, showStats){
      super(name, "Enhancement", description, image, primaryCost, "Primary", secondaryCost, "Secondary", energyCost, 0);
      this.enhancementDescription = enhancementDescription;
      this.enhancementType = enhancementType;
      this.enhancementModifier = enhancementModifier;
      this.enhancementMultiplier = enhancementMultiplier;
      this.showStats = showStats
      if (this.showStats){
        this.buildEnhancementVisuals();
      }
    }

    buildEnhancementVisuals(){
      this.#createEmptyElements();
      this.#assignElementClasses();
      this.#relateElements();
      this.#fillInnerHTML();
    }
    #createEmptyElements(){
      this.enhancementCellElement = document.createElement("td");
    }
    #assignElementClasses(){
      this.enhancementCellElement.className = "componentStatCell";
    }
    #relateElements(){
      this.modifierRowElement.appendChild(this.enhancementCellElement);
    }
    #fillInnerHTML(){
      var formattedEnhancementCell = this.enhancementType + ": " + this.getSign(this.enhancementModifier);
      if (this.enhancementMultiplier != 1){
        formattedEnhancementCell += " (" + this.enhancementMultiplier + "x)"
      }
      this.enhancementCellElement.innerHTML = formattedEnhancementCell;
    }
  }

  function mainMenuSpellsButtonPress(){
    hideMainMenu();
  }

  function mainMenuMartialsButtonPress(){
    hideMainMenu();
  }

  function hideMainMenu(){
    mainMenuSpellsButton.disabled = true;
    mainMenuMartialsButton.disabled = true;
    mainMenuScreen.style.display = "none";
  }

  function unhideMainMenu(){
    mainMenuScreen.style.display = "flex";
    mainMenuSpellsButton.disabled = false;
    mainMenuMartialsButton.disabled = false;
  }

  function assignToolTip(toolTipButton){
    toolTipButton.addEventListener('mousemove', function(event){
      updateToolTipPosition(event, toolTipButton)}
      );
  }
  
  function updateToolTipPosition(mouseEvent, toolTipButton){
    const toolTip = toolTipButton.getElementsByClassName("toolTip")[0];
    const clientX = mouseEvent.clientX;
    const clientY = mouseEvent.clientY;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    const toolTipWidth = toolTip.offsetWidth;
    const toolTipHeight = toolTip.offsetHeight;

    if (clientX + toolTipWidth + 18 > windowWidth){
      toolTip.style.left = (windowWidth - toolTipWidth) + "px";
    }else{
      toolTip.style.left = clientX + 18 + "px";
    }

    if (clientY + toolTipHeight + 12 > windowHeight){
      toolTip.style.top = (windowHeight - toolTipHeight) + "px";
    }else{
      toolTip.style.top = clientY + 12 + "px";
    }
  }

  function readJSONDirectory(dirPath){
    fs.readdirSync(dirPath).forEach(file => {
      fetchRawJSON(dirPath + "/" + file);
    });
  }

  function fetchRawJSON(fileName){
    fetch(fileName)
      .then(response => response.json())
      .then(jsonResponse => {
        convertJSONToSpellComponent(jsonResponse)});
  }

  function convertJSONToSpellComponent(json){
    switch (json.type){
      case "Form":
        createFormComponentFromJSON(json);
        return;
      case "Path":
        createPathComponentFromJSON(json);
        return;
      case "Trigger":
        createTriggerComponentFromJSON(json);
        return;
      case "Enhancement":
        createEnhancementComponentFromJSON(json);
        return;
      case "Purpose":
        createPurposeComponentFromJSON(json);
        return;
      default:
        createVoidComponentFromJSON(json);
        return;
    }
  }

  function createFormComponentFromJSON(json){
    new formComponent(
      json.name,
      json.description,
      json.formDescription,
      json.image,
      json.costs.primary,
      json.costs.secondary,
      json.costs.energy,
      json.potency,
      json.size
    );
  }

  function createPathComponentFromJSON(json){
    new pathComponent(
      json.name,
      json.description,
      json.pathDescription,
      json.image,
      json.costs.primary,
      json.costs.secondary,
      json.costs.energy,
      json.potency,
      json.range,
      json.lifetime
    );
  }

  function createTriggerComponentFromJSON(json){
    new triggerComponent(
      json.name,
      json.description,
      json.triggerDescription,
      json.image,
      json.costs.primary,
      json.costs.secondary,
      json.costs.energy,
      json.potency
    );
  }

  function createEnhancementComponentFromJSON(json){
    new enhancementComponent(
      json.name,
      json.description,
      json.enhancementDescription,
      json.image,
      json.costs.primary,
      json.costs.secondary,
      json.costs.energy,
      json.enhancement.type,
      json.enhancement.modifier,
      json.enhancement.multiplier,
      json.enhancement.showStats
    );
  }

  function createVoidComponentFromJSON(json){
    new spellComponent(
      json.name,
      json.type,
      json.description,
      json.image,
      json.costs.primary,
      json.vis.primary,
      json.costs.secondary,
      json.vis.secondary,
      json.costs.energy,
      json.potency
    );
  }
</script>